# Example HyperFleet Adapter task configuration
apiVersion: hyperfleet.redhat.com/v1alpha1
kind: AdapterTaskConfig
metadata:
  name: adapter1
  labels:
    hyperfleet.io/adapter-type: adapter1
    hyperfleet.io/component: adapter
spec:
  # Parameters with all required variables
  params:


    - name: "clusterId"
      source: "event.id"
      type: "string"
      required: true

    - name: "generation"
      source: "event.generation"
      type: "int"
      required: true

    - name: "namespace"
      source: "env.NAMESPACE"
      type: "string"

  # Preconditions with valid operators and CEL expressions
  preconditions:
    - name: "clusterStatus"
      apiCall:
        method: "GET"
        url: "/clusters/{{ .clusterId }}"
        timeout: 10s
        retryAttempts: 3
        retryBackoff: "exponential"
      capture:
        - name: "clusterName"
          field: "name"
        - name: "generation"
          field: "generation"
        - name: "readyConditionStatus"
          expression: |
            status.conditions.filter(c, c.type == "Ready").size() > 0
              ? status.conditions.filter(c, c.type == "Ready")[0].status
              : "False"
      # Structured conditions with valid operators
      conditions:
        - field: "readyConditionStatus"
          operator: "equals"
          value: "False"

    - name: "validationCheck"
      # Valid CEL expression
      expression: |
        readyConditionStatus == "False"

  # Resources with valid K8s manifests
  resources:
    - name: "resource0"
      transport:
        client: "kubernetes"
      manifest:
        apiVersion: v1
        kind: ConfigMap
        data:
          cluster_id: "{{ .clusterId }}"
          cluster_name: "{{ .clusterName }}"
        metadata:
          name: "{{ .clusterId }}-adapter1-configmap"
          namespace: "{{ .namespace }}"
          labels:
            app.kubernetes.io/component: adapter
            app.kubernetes.io/instance: adapter1
            app.kubernetes.io/name: hyperfleet-adapter
            app.kubernetes.io/version: 1.0.0
            app.kubernetes.io/transport: kubernetes
            hyperfleet.io/cluster-id: "{{ .clusterId }}"
            hyperfleet.io/cluster-name: "{{ .clusterName }}"
      discovery:
        namespace: "{{ .namespace }}"
        bySelectors:
          labelSelector:
            hyperfleet.io/cluster-id: "{{ .clusterId }}"
            hyperfleet.io/cluster-name: "{{ .clusterName }}"

  # Post-processing with valid CEL expressions
  # This example contains multiple resources, we will only report on the conditions of the jobNamespace not to overcomplicate the example
  post:
    payloads:
      - name: "statusPayload"
        build:
          # TODO: this should come from config.adapter.metadata.name
          adapter: "adapter1"
          conditions:
            # Applied: Job successfully created
            - type: "Applied"
              status:
                expression: |
                  has(resources.resource0.metadata.creationTimestamp) ? "True" : "False"
              reason:
                expression: |
                  has(resources.resource0.metadata.creationTimestamp) ? "ConfigMapApplied" : "ConfigMapPending"
              message:
                expression: |
                  has(resources.resource0.metadata.creationTimestamp) 
                  ? "ConfigMap has been applied correctly" 
                  : "ConfigMap is pending to be applied"
            # Available: Check job status conditions
            - type: "Available"
              status:
                expression: |
                  has(resources.resource0.data.clusterId) ? "True" : "False"
              reason:
                expression: |
                  has(resources.resource0.data.clusterId) 
                    ? "ConfigMap data available"
                    : "ConfigMap data not yet available"
              message:
                expression: |
                  has(resources.resource0.data.clusterId) 
                    ? "ConfigMap data available"
                    : "ConfigMap data not yet available"
            # Health: Adapter execution status (runtime)
            - type: "Health"
              status:
                expression: |
                  has(resources.resource0.data.clusterId) ? "True" : "False"
              reason:
                expression: |
                  has(resources.resource0.data.clusterId) 
                    ? "ConfigMap data available"
                    : "ConfigMap data not yet available"
              message:
                expression: |
                  has(resources.resource0.data.clusterId) 
                    ? "ConfigMap data available"
                    : "ConfigMap data not yet available"
          # Event generation ID metadata field needs to use expression to avoid interpolation issues
          observed_generation:
            expression: "generation"
          observed_time: "{{ now | date \"2006-01-02T15:04:05Z07:00\" }}"
          # Optional data field for adapter-specific metrics extracted from resources
          data:
            namespace:
              name:
                expression: |
                  resources.?resources.resource0.?metadata.?name.orValue("")
              creationTimestamp:
                expression: |
                  resources.?resources.resource0.?metadata.?creationTimestamp.orValue("")

    postActions:
      - name: "reportClusterStatus"
        apiCall:
          method: "POST"
          url: "/clusters/{{ .clusterId }}/statuses"
          headers:
            - name: "Content-Type"
              value: "application/json"
          body: "{{ .statusPayload }}"
